<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="t-frequent-flyer.html">
<link rel="import" href="t-passenger-segment.html">
<link rel="import" href="t-passport-info.html">
<link rel="import" href="t-communication.html">
<link rel="import" href="../t-sessionstorage/t-sessionstorage.html">
<link rel="import" href="../t-button/t-button.html">
<link rel="import" href="../t-section-header/t-section-header.html" />
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html" />
<link rel="import" href="../iron-ajax/iron-request.html">

<!--
    <h3>Details:</h3>

        `t-passenger-info-page` is a passenger infor page component which displays & stores passenger information.

        It uses following child components in it -
            1. `t-frequent-flyer`
            2. `t-passenger-segment`
            3. `t-passport-info`
            4. `t-communication`
            5. `t-button`
            6. `t-sessionstorage`
            7. `t-section-header`

    <h3>Events:</h3>

        following events are fired by this component

            1. 'confirmation-error' - fired when error is occured while fetching booked itinerary from session, session is currently not used in this page.
            2. 'confirmation-success' - fired when confirmation page is loaded succesfully.
            3. `go-to-search` - fired when page is loaded without required page data.

    <h3>Example:</h3>

        <t-passenger-info-page
            id="passengerInfo"
            name="paxInfo"
            product="car"
            hide-gender
            hide-date-of-birth
            hide-suffix
            hide-middle-name
            api-url-format="[[apiUrlFormat]]"
            passenger-info="{{passengerInfo}}"
            on-passenger-save-success="_goToPaymentPage">
            <t-header
                icon="bgv:arrow-left"
                 url="[[siteUrl]]car/details"
                label="Guest Info"
                normal-heading>
            </t-header>
        </t-passenger-info-page>

    @demo demo/index.html
-->

<dom-module id="t-passenger-info-page">
    <template>
        <style>
            :host, t-button {
                display: block;
            }
            #savePassengers {
               margin: var(--normal-spacing,10px);
            }
            t-section-header {
                margin-bottom: 0;
            }
        </style>

        <t-notify type="error" id="notify"></t-notify>

        <content select="t-header"></content>

        <div class="layout vertical">
            <template 
                id="list" 
                is="dom-repeat" 
                items="[[passengerInfo.passengerList]]" 
                as="passenger">

                    <t-section-header 
                        label="{{_getPaxHeader(passenger.type)}}">
                    </t-section-header>

                    <t-passenger-segment
                        id="paxSegment"
                        title="{{passenger.title}}"
                        first-name="{{passenger.firstName}}"
                        middle-name="{{passenger.middleName}}"
                        last-name="{{passenger.lastName}}"
                        type="{{passenger.type}}"
                        gender="{{passenger.genderString}}"
                        suffix="{{passenger.suffix}}"
                        date-of-birth="{{passenger.dob}}"
                        hide-middle-name="[[hideMiddleName]]"
                        hide-suffix="[[hideSuffix]]"
                        hide-title="[[hideTitle]]"
                        hide-date-of-birth="[[hideDateOfBirth]]"
                        hide-gender="{{hideGender}}">
                    </t-passenger-segment>

                    <template is="dom-if" if="[[isPassportRequired]]">
                        <div class="vertical-margin layout">
                            <t-passport-info 
                                issue-country={{passenger.PassportInfo.IssuingCountry}}
                                nationality-country="{{passenger.PassportInfo.NationalityCountry}}"
                                passport-number="{{passenger.PassportInfo.PassportNumber}}"
                                date-of-expiry="{{passenger.PassportInfo.ExpiryDateString}}"
                                countries="[[countries.result]]">                           
                            </t-passport-info>
                        </div>
                    </template>

                    <template is="dom-if" if="{{_isFlight(passenger.type)}}">
                        <div class="vertical-margin layout">
                            <t-frequent-flyer
                                passenger-id="[[index]]" 
                                chosen-programs="[[passenger.optedPrograms]]" 
                                airline-list="[[airlineList]]" 
                                frequent-flyer-url="[[frequentFlyerUrl]]">
                            </t-frequent-flyer>
                        </div>
                    </template>

            </template>
        </div>

        <t-communication
            phone="{{passengerInfo.phone}}" 
            email="{{passengerInfo.email}}">                
        </t-communication>

        <t-button 
            id="savePassengers"
            class="primary row" 
            on-click="savePassengerData" 
            type="button" 
            label="continue">               
        </t-button>

        <iron-ajax 
            id="countryCall" 
            url="[[countryApi]]" 
            method="GET" 
            verbose 
            headers='{"accept": "application/json"}' 
            handle-as="json" 
            content-type="application/json" 
            last-response="{{countries}}">                
        </iron-ajax>

        <t-sessionstorage
            id="sessionStore"
            key="Car_Passenger_Info"
            api-url-format="[[apiUrlFormat]]"
            on-t-sessionstorage-save-success="onSessionSave"
            on-t-sessionstorage-load-success="onSessionLoad">
        </t-sessionstorage>
    </template>

    <script>

        (function () {

            'use strict'
            
            Polymer({

                is: 't-passenger-info-page',

                properties: {

                    /*
                     * <p>This is a notification flag to indicate current page state</p>
                     * <p>Set it to true if page needs to be displayed on browser</p>
                    */
                    visible: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    /*
                     * <p>This string is query string containing token value</p>
                    */
                    authToken: {
                        type: String,
                        value: ''
                    },

                    /*
                     * <p>This property holds the value of api base URL</p>
                    */
                    apiBaseUrl: {
                        type: String,
                        value: ''
                    },

                    /*
                     * <p>This property holds the value of web api URL format</p>
                    */
                    apiUrlFormat: {
                        type: String,
                        value: ''
                    },

                    product: {
                        type: String
                    },

                    passengerInfo: {
                        type: Object,
                        notify: true
                    },

                    isPassportRequired: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Pass true to hide MiddleName
                    */
                    hideMiddleName: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Pass true to hide Suffix
                     */
                    hideSuffix: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Pass true to hide Title
                     */
                    hideTitle: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Pass true to hide DateOfBirth
                     */
                    hideDateOfBirth: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Pass true to hide Gender
                     */
                    hideGender: {
                        type: Boolean,
                        value: false
                    }
                },

                observers: [
                    '_visibleChange(visible)'
                ],

                /*
                 * <p>this method gets called when page becomes visible</p>
                */
                _visibleChange: function (visible) {
                    this.$.savePassengers.disabled = true;
                    if (visible) {
                        this.$.sessionStore.load();
                    }
                    setTimeout(function () {                        
                        this.$.savePassengers.disabled = false;
                    }.bind(this), 10)
                },

                onSessionLoad: function () {
                    if (this.$.sessionStore.value) {
                        this.passengerInfo = this.$.sessionStore.value;
                    } else{
                        this._buildPassengerInfo();
                    }
                },

                /*
                 * <p>This is the success event handler for `t-sessionstorage` load component</p>
                */
                onSessionSave:function () {
                    if (this.$.sessionStore.value) {
                        this.passengerInfo = this.$.sessionStore.value;
                        this.fire('passenger-save-success');
                    }
                },

                /*
                 * <p>This method gets product specific header names.</p>
                */
                _getPaxHeader: function (type) {
                    if (this.product.toLowerCase() === 'car') {
                        return 'Driver Name'
                    }
                    var index = this._getDisplayIndex(type);
                    return this._getType(type) + " " + index;
                },

                /*
                 * <p>Checks if the prodcut is flight</p>
                */
                _isFlight: function (type) {
                    return type.toLowerCase() === 'flight';
                },

                /*
                 * <p>Builds passenger info as per selected product</p>
                */
                _buildPassengerInfo: function () {
                    //this list will be built using product type
                    //As of now building passenger info required for car details

                    this.passengerInfo = {
                        passengerList: [{
                            title: "",
                            firstName: "",
                            // "middleName": "Madhavrao",
                            lastName: "",
                            // "suffix": "Jr",
                            // "dob": "09/12/1990",
                            // "gender": "Male",
                            type: "Adult",
                            // "EmailId": "asd@asd.asd"
                        }   ],
                        phone: '',
                        email: ''
                    };
                },

                /*
                 * <p>Validates passenger inofrmation</p>
                */
                validate: function () {
                    if (this.$.savePassengers.disabled) {
                        return;
                    }
                    var isValid = true;
                    isValid = this.querySelector('t-passenger-segment').validate() && isValid;
                    isValid = this.querySelector('t-communication').validate() && isValid;
                    return isValid;
                },

                /*
                 * <p>Event handler called on save button click</p>
                */
                savePassengerData: function () {
                    if (this.validate()) {
                        this.$.sessionStore.value = this.passengerInfo;
                        this.passengerInfo = null;
                        this.$.sessionStore.save();
                    }
                }
            });

        })();

    </script>
</dom-module>
