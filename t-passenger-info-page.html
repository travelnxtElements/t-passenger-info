<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="t-frequent-flyer.html">
<link rel="import" href="t-passenger-segment.html">
<link rel="import" href="t-passport-info.html">
<link rel="import" href="t-communication.html">
<link rel="import" href="../t-sessionstorage/t-sessionstorage.html">
<link rel="import" href="../t-button/t-button.html">
<link rel="import" href="../t-section-header/t-section-header.html" />
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html" />
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="../t-behavior/t-page-behavior.html">
<link rel="import" href="../t-behavior/t-activity-page-behavior.html">

<!--
    <h3>Details:</h3>

        `t-passenger-info-page` is a passenger infor page component which displays & stores passenger information.

        It uses following child components in it -
            1. `t-frequent-flyer`
            2. `t-passenger-segment`
            3. `t-passport-info`
            4. `t-communication`
            5. `t-button`
            6. `t-sessionstorage`
            7. `t-section-header`

    <h3>Events:</h3>

        following events are fired by this component

            1. 'confirmation-error' - fired when error is occured while fetching booked itinerary from session, session is currently not used in this page.
            2. 'confirmation-success' - fired when confirmation page is loaded succesfully.
            3. `go-to-search` - fired when page is loaded without required page data.

    <h3>Example:</h3>

        <t-passenger-info-page
            id="passengerInfo"
            name="paxInfo"
            product="car"
            hide-gender
            hide-date-of-birth
            hide-suffix
            hide-middle-name
            api-url-format="[[apiUrlFormat]]"
            passenger-info="{{passengerInfo}}"
            on-passenger-save-success="_goToPaymentPage">
            <t-header
                icon="bgv:arrow-left"
                 url="[[siteUrl]]car/details"
                label="Guest Info"
                normal-heading>
            </t-header>
        </t-passenger-info-page>

    @demo demo/index.html
-->

<dom-module id="t-passenger-info-page">
    <template>
        <style>
            :host, t-button {
                display: block;
            }
            #savePassengers {
               margin: var(--normal-spacing,10px);
            }
            t-section-header {
                margin-bottom: 0;
            }
        </style>

        <t-notify type="error" id="notify"></t-notify>

        <content select="t-header"></content>

        <div class="layout vertical">
            <template 
                id="list" 
                is="dom-repeat" 
                items="[[passengerInfo.passengerList]]" 
                as="passenger">

                    <t-section-header 
                        label="[[passenger.header]]">
                    </t-section-header>

                    <t-passenger-segment
                        title="{{passenger.title}}"
                        first-name="{{passenger.firstName}}"
                        middle-name="{{passenger.middleName}}"
                        last-name="{{passenger.lastName}}"
                        type="{{passenger.type}}"
                        gender="{{passenger.genderString}}"
                        suffix="{{passenger.suffix}}"
                        date-of-birth="{{passenger.dob}}"
                        hide-middle-name="[[hideMiddleName]]"
                        hide-suffix="[[hideSuffix]]"
                        hide-title="[[hideTitle]]"
                        hide-date-of-birth="[[hideDateOfBirth]]"
                        hide-gender="{{hideGender}}"
                        min-age="[[passenger.minAge]]"
                        max-age="[[passenger.maxAge]]"
                        departure-date="[[departureDate]]">
                    </t-passenger-segment>

                    <template is="dom-if" if="[[isPassportRequired]]">
                        <div class="vertical-margin layout">
                            <t-passport-info 
                                issue-country={{passenger.PassportInfo.IssuingCountry}}
                                nationality-country="{{passenger.PassportInfo.NationalityCountry}}"
                                passport-number="{{passenger.PassportInfo.PassportNumber}}"
                                date-of-expiry="{{passenger.PassportInfo.ExpiryDateString}}"
                                countries="[[countries.result]]">                           
                            </t-passport-info>
                        </div>
                    </template>

                    <template is="dom-if" if="{{_isFlight(passenger.type)}}">
                        <div class="vertical-margin layout">
                            <t-frequent-flyer
                                passenger-id="[[index]]" 
                                chosen-programs="[[passenger.optedPrograms]]" 
                                airline-list="[[airlineList]]" 
                                frequent-flyer-url="[[frequentFlyerUrl]]">
                            </t-frequent-flyer>
                        </div>
                    </template>

            </template>
        </div>

        <t-communication
            phone="{{passengerInfo.phone}}" 
            email="{{passengerInfo.email}}">                
        </t-communication>

        <t-button 
            id="savePassengers"
            class="primary row" 
            on-click="savePassengerData" 
            type="button" 
            label="continue">               
        </t-button>

        <iron-ajax 
            id="countryCall" 
            url="[[countryApi]]" 
            method="GET" 
            verbose 
            headers='{"accept": "application/json"}' 
            handle-as="json" 
            content-type="application/json" 
            last-response="{{countries}}">                
        </iron-ajax>

        <t-sessionstorage
            id="sessionStore"
            key="Car_Passenger_Info"
            api-url-format="[[apiUrlFormat]]"
            on-t-sessionstorage-save-success="onSessionSave"
            on-t-sessionstorage-load-success="onSessionLoad">
        </t-sessionstorage>
    </template>

    <script>

        (function () {

            'use strict'

            var passenger = {
                title: "",
                firstName: "",
                middleName: "",
                lastName: "",
                suffix: "",
                dob: "",
                gender: "",
                type: "",
                emailId: "",
                header: ""
            };
            
            Polymer({

                is: 't-passenger-info-page',

                behaviors: [
                    TravelNxt.Behaviors.PageBehavior,
                    TravelNxt.Behaviors.ActivityPageBehavior
                ],

                properties: {

                    /*
                     * <p>This property holds the value of product type e.g. hotel</p>
                    */
                    product: {
                        type: String
                    },

                    /*
                     * <p>This object holds the value of saved passenger information</p>
                     * <p>It overrides behavior property</p>
                    */
                    passengerInfo: {
                        type: Object,
                        notify: true
                    },

                    /*
                     * <p>Flag to toggle passport details view</p>
                    */
                    isPassportRequired: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Pass true to hide MiddleName
                    */
                    hideMiddleName: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Pass true to hide Suffix
                     */
                    hideSuffix: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Pass true to hide Title
                     */
                    hideTitle: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Pass true to hide DateOfBirth
                     */
                    hideDateOfBirth: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Pass true to hide Gender
                     */
                    hideGender: {
                        type: Boolean,
                        value: false
                    },

                    /*
                     * <p>This property sets the title for primary passenger</p>
                    */
                    primaryHeader: {
                        type: String,
                        value:'Adult 1'
                    },

                    /**
                     * Number of adults
                     */
                    adultCount: {
                        type: Number,
                        value: 1
                    },

                    /**
                     * Number of children
                     */
                    childCount: {
                        type: Number,
                        value: 0
                    },

                    /**
                     * Number of Infants
                     */
                    infantCount: {
                        type: Number,
                        value: 0
                    },

                    /**
                     * This date is used as a reference to restrict ages in calender.
                     * The age ranged will be determined by `ageMappings` property.                     
                     */
                    departureDate: {
                        type: Date
                    },

                    /**
                     * Provides passengerwise minimum & maximum age mappings
                     * This object stores a property for each passenger type.
                     * key of this property is `passenger type` & value is an object with minimum and maximum age.
                     * Refer description for sample object structure
                     */
                    ageMappings: {
                        type: Object
                    }
                },

                observers: [
                    '_visibleChange(visible)'
                ],

                /*
                 * <p>this method gets called when page becomes visible</p>
                */
                _visibleChange: function (visible) {
                    this.$.savePassengers.disabled = true;
                    if (visible) {
                        this.$.sessionStore.load();
                    }
                    setTimeout(function () {                        
                        this.$.savePassengers.disabled = false;
                    }.bind(this), 10)
                },

                /*
                 * <p>This is the success event handler for `t-sessionstorage` save event</p>
                */
                onSessionLoad: function () {
                    if (this.$.sessionStore.value) {
                        this.passengerInfo = this.$.sessionStore.value;
                    } else{
                        this._buildPassengerInfo();
                    }

                    if (this.primaryHeader && this.passengerInfo && this.passengerInfo.passengerList) {
                        this.passengerInfo.passengerList[0].header = this.primaryHeader;
                    }
                },

                /*
                 * <p>This is the success event handler for `t-sessionstorage` load event</p>
                */
                onSessionSave:function () {
                    if (this.$.sessionStore.value) {
                        this.passengerInfo = this.$.sessionStore.value;
                        this.fire('passenger-save-success');
                    }
                },

                /*
                 * <p>Checks if the prodcut is flight</p>
                */
                _isFlight: function (type) {
                    return type.toLowerCase() === 'flight';
                },

                /*
                 * <p>Builds passenger info as per selected product</p>
                */
                _buildPassengerInfo: function () {

                    var passengerList = [];

                    passengerList = this._getAdultData(passengerList);
                    passengerList = this._getChildrenData(passengerList);
                    passengerList = this._getInfantData(passengerList);

                    this.passengerInfo = {
                        passengerList: passengerList,
                        phone: '',
                        email:''
                    };
                },

                /*
                 * <p>Builds data for all adults</p>
                */
                _getAdultData: function (passengerList) {

                    //atleast 1 adult has to be there
                    if (!this.adultCount) {
                        this.adultCount = 1;
                    }


                    for (var i = 1; i <= this.adultCount; i++) {
                        var newPassenger = Object.create(passenger);
                        newPassenger.type = 'Adult';
                        this._setAgeRange(newPassenger);
                        newPassenger.header = newPassenger.type + ' ' + i;
                        passengerList.push(newPassenger);
                    }
                    return passengerList;
                },

                /*
                 * <p>Builds data for all children</p>
                */
                _getChildrenData: function (passengerList) {
                    if (!this.childCount) {
                        return passengerList;
                    }

                    for (var i = 1; i <= this.childCount; i++) {
                        var newPassenger = Object.create(passenger);
                        newPassenger.type = 'Child';
                        this._setAgeRange(newPassenger);
                        newPassenger.header = newPassenger.type + ' ' + i;
                        passengerList.push(newPassenger);
                    }
                    return passengerList;
                },

                /*
                 * <p>Builds data for all infants</p>
                */
                _getInfantData: function (passengerList) {
                    if (!this.infantCount) {
                        return passengerList;
                    }

                    for (var i = 1; i <= this.infantCount; i++) {
                        var newPassenger = Object.create(passenger);
                        newPassenger.type = 'Infant';
                        this._setAgeRange(newPassenger);
                        newPassenger.header = newPassenger.type + ' ' + i;
                        passengerList.push(newPassenger);
                    }
                    return passengerList;
                },

                /*
                 * <p>Checks if the prodcut is flight</p>
                */
                _setAgeRange: function (passenger) {
                    if (!this.ageMappings) {
                        return;
                    }

                    var mapping = this.ageMappings[passenger.type.toLowerCase()];

                    if (!mapping) {
                        return;
                    }

                    passenger.minAge = mapping.minAge;
                    passenger.maxAge = mapping.maxAge;
                },

                /*
                 * <p>Validates passenger information</p>
                */
                validate: function () {
                    if (this.$.savePassengers.disabled) {
                        return;
                    }
                    var isValid = true;
                    this.querySelectorAll('t-passenger-segment').forEach(function (item) {
                        item.validate() && isValid;
                    })
                    isValid = this.querySelector('t-communication').validate() && isValid;
                    return isValid;
                },

                /*
                 * <p>Event handler called on save button click</p>
                */
                savePassengerData: function () {
                    if (this.validate()) {
                        this.$.sessionStore.value = this.passengerInfo;
                        this.passengerInfo = null;
                        this.$.sessionStore.save();
                    }
                }
            });

        })();

    </script>
</dom-module>
